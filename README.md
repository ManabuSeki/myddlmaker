# myddlmaker

![Build Status](https://github.com/shogo82148/myddlmaker/workflows/Go/badge.svg)
[![Go Reference](https://pkg.go.dev/badge/github.com/shogo82148/myddlmaker.svg)](https://pkg.go.dev/github.com/shogo82148/myddlmaker)

myddlmaker is generate DDL (Data Definition Language) from Go structs.
It is a fork of [kayac/ddl-maker](https://github.com/kayac/ddl-maker) that focuses to use with MySQL.

## SYNOPSIS

Firstly, write your table definitions as Go structures.
Here is an example: [schema.go](./testdata/example/schema.go)

```go
package schema

import (
	"time"

	"github.com/shogo82148/myddlmaker"
)

//go:generate go run -tags myddlmaker gen/main.go

type User struct {
	ID        uint64 `ddl:",auto"`
	Name      string
	CreatedAt time.Time
}

func (*User) PrimaryKey() *myddlmaker.PrimaryKey {
	return myddlmaker.NewPrimaryKey("id")
}
```

Next, configure your DDL maker: [gen/main.go](./testdata/example/gen/main.go)

```go
package main

import (
	"log"

	"github.com/shogo82148/myddlmaker"
	schema "github.com/shogo82148/myddlmaker/testdata/example"
)

func main() {
	// create a new DDL maker.
	m, err := myddlmaker.New(&myddlmaker.Config{
		DB: &myddlmaker.DBConfig{
			Engine:  "InnoDB",
			Charset: "utf8mb4",
		},
		OutFilePath:   "schema.sql",
		OutGoFilePath: "schema_gen.go",
		PackageName:   "schema",
		Tag:           "myddlmaker",
	})
	if err != nil {
		log.Fatal(err)
	}

	m.AddStructs(&schema.User{})

	// generate an SQL file.
	if err := m.GenerateFile(); err != nil {
		log.Fatal(err)
	}

	// generate Go source code for basic SQL operations
	// such as INSERT, SELECT, and UPDATE.
	if err := m.GenerateGoFile(); err != nil {
		log.Fatal(err)
	}
}
```

Run `go generate`.

```console
$ go generate ./...
```

You can get the following SQL queries:

```sql
SET foreign_key_checks=0;

DROP TABLE IF EXISTS `user`;

CREATE TABLE `user` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(191) NOT NULL,
    `created_at` DATETIME NOT NULL,
    PRIMARY KEY (`id`)
) ENGINE = InnoDB DEFAULT CHARACTER SET = utf8mb4;

SET foreign_key_checks=1;
```

And more, the DDL maker generates Go source code for basic SQL operations such as INSERT, SELECT, and UPDATE.

```go
// Code generated by https://github.com/shogo82148/myddlmaker; DO NOT EDIT.

//go:build !myddlmaker

package schema

import (
	"context"
	"database/sql"
)

type execer interface {
	ExecContext(ctx context.Context, query string, args ...any) (sql.Result, error)
	PrepareContext(ctx context.Context, query string) (*sql.Stmt, error)
}

type queryer interface {
	QueryContext(ctx context.Context, query string, args ...any) (*sql.Rows, error)
	QueryRowContext(ctx context.Context, query string, args ...any) *sql.Row
	PrepareContext(ctx context.Context, query string) (*sql.Stmt, error)
}

func InsertUser(ctx context.Context, execer execer, values ...*User) error {
	const q = "INSERT INTO `user` (`name`, `created_at`) VALUES (?, ?)"
    // (snip)
	return nil
}

func SelectUser(ctx context.Context, queryer queryer, primaryKeys *User) (*User, error) {
	var v User
	row := queryer.QueryRowContext(ctx, "SELECT `id`, `name`, `created_at` FROM `user` WHERE `id` = ?", primaryKeys.ID)
	if err := row.Scan(&v.ID, &v.Name, &v.CreatedAt); err != nil {
		return nil, err
	}
	return &v, nil
}

func UpdateUser(ctx context.Context, execer execer, values ...*User) error {
	stmt, err := execer.PrepareContext(ctx, "UPDATE `user` SET `name` = ?, `created_at` = ? WHERE `id` = ?")
	if err != nil {
		return err
	}
	defer stmt.Close()
	for _, value := range values {
		if _, err := stmt.ExecContext(ctx, value.Name, value.CreatedAt, value.ID); err != nil {
			return err
		}
	}
	return nil
}
```

You can use these generated functions in your application.

```go
db, _ := sql.Open("mysql", "user:password@/dbname")

// INSERT INTO `user` (`name`, `created_at`) VALUES ("Alice", NOW());
schema.InsertUser(context.TODO(), db, &schema.User{
	Name:      "Alice",
	CreatedAt: time.Now(),
})

// SELECT * FROM `user` WHERE `id` = 1;
user, err := schema.SelectUser(context.TODO(), db, &schema.User{
	ID: 1,
})

// UPDATE `user` SET `name` = "Bob", `created_at` = NOW() WHERE `id` = 1;
schema.UpdateUser(context.TODO(), db, &schema.User{
	ID: 1,
	Name: "Bob",
	CreatedAt: time.Now(),
})
```
